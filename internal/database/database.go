// Пакет database отвечает за работу с базой данных
// Здесь находятся функции для подключения к БД и выполнения SQL запросов
package database

// Импортируем необходимые пакеты
import (
	"fmt" // Пакет для форматирования строк
	"time"

	"github.com/jmoiron/sqlx" // Расширение для database/sql с удобными функциями
	_ "github.com/lib/pq"     // Драйвер PostgreSQL (символ _ означает, что импортируем только для side-effects)
)

// Connect создает подключение к базе данных PostgreSQL
// Принимает строку подключения и возвращает объект DB и ошибку (если есть)
// *sqlx.DB - указатель на структуру DB из библиотеки sqlx
// error - интерфейс для представления ошибок в Go
func Connect(databaseURL string) (*sqlx.DB, error) {
	// sqlx.Connect открывает соединение с БД и сразу проверяет его (ping)
	// "postgres" - название драйвера для PostgreSQL
	// databaseURL - строка подключения (пример: postgres://user:pass@localhost/dbname)
	db, err := sqlx.Connect("postgres", databaseURL)

	// Проверяем, произошла ли ошибка при подключении
	if err != nil {
		// fmt.Errorf создает новую ошибку с форматированным сообщением
		// %w - специальный глагол для "оборачивания" оригинальной ошибки
		return nil, fmt.Errorf("ошибка подключения к базе данных: %w", err)
	}

	// Настраиваем пул соединений с БД
	// SetMaxOpenConns устанавливает максимальное количество открытых соединений
	// 25 - хорошее значение по умолчанию для небольших приложений
	db.SetMaxOpenConns(25)
	db.SetConnMaxLifetime(time.Hour)

	// SetMaxIdleConns устанавливает максимальное количество простаивающих соединений
	// Эти соединения остаются открытыми и готовы к переиспользованию
	db.SetMaxIdleConns(5)

	// Возвращаем успешное подключение и nil (отсутствие ошибки)
	return db, nil
}
