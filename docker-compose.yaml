# Docker Compose файл для запуска PostgreSQL локально
# Этот файл описывает сервисы, которые нужно запустить для работы приложения

version: '3.8'

# Список сервисов (контейнеров), которые будут запущены
services:
  # Сервис базы данных PostgreSQL
  postgres:
    # Используем официальный образ PostgreSQL версии 15
    image: postgres:15-alpine

    # Имя контейнера для удобства
    container_name: order_database

    # Переменные окружения для настройки PostgreSQL
    environment:
      # Имя базы данных, которая будет создана при первом запуске
      POSTGRES_DB: orderdb
      # Имя пользователя для подключения к БД
      POSTGRES_USER: orderuser
      # Пароль для пользователя БД
      POSTGRES_PASSWORD: orderpass

    # Пробрасываем порт 5432 из контейнера на локальную машину
    # Формат: "порт_на_локальной_машине:порт_в_контейнере"
    ports:
      - "5434:5432"

    # Монтируем volume для сохранения данных БД
    # Даже после остановки контейнера данные сохранятся
    volumes:
      # Автоматический volume для данных PostgreSQL
      - postgres_data:/var/lib/postgresql/data
      # Монтируем SQL скрипт инициализации БД
      # Все .sql файлы из этой папки выполнятся при первом запуске
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql

    # Настройка проверки здоровья контейнера
    healthcheck:
      # Команда для проверки, что PostgreSQL запустился и готов принимать соединения
      test: ["CMD-SHELL", "pg_isready -U orderuser -d orderdb"]
      # Интервал между проверками
      interval: 10s
      # Время ожидания ответа
      timeout: 5s
      # Количество попыток перед тем, как контейнер будет считаться нездоровым
      retries: 5

# Определяем volumes (хранилища данных)
volumes:
  # Volume для хранения данных PostgreSQL
  postgres_data: